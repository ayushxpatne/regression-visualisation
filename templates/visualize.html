{% extends "base.html" %}

{% block title %}Visualize - Regression Visualizer{% endblock %}

{% block content %}
<style>
/* *** CSS to enhance slider visibility ***
    Styles the slider track (the line) to make it more prominent and consistent.
*/
input[type="range"] {
    -webkit-appearance: none;
    background: transparent; 
    width: 100%;
    height: 16px; /* Total height of the clickable area */
}

/* Styling the track for Chrome, Safari, and Edge */
input[type="range"]::-webkit-slider-runnable-track {
    width: 100%;
    height: 8px; /* Height of the visible line */
    background: #d1d5db; /* Light gray track color */
    border-radius: 4px;
    cursor: pointer;
}

/* Styling the track for Firefox */
input[type="range"]::-moz-range-track {
    width: 100%;
    height: 8px; /* Height of the visible line */
    background: #d1d5db; /* Light gray track color */
    border-radius: 4px;
    cursor: pointer;
    border: none; /* Remove default border in Firefox */
}

/* Adjusting the thumb (knob) position for Chrome/Safari/Edge to center it on the track */
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 16px;
    width: 16px;
    border-radius: 50%;
    background: #111827; /* Dark knob color */
    cursor: pointer;
    margin-top: -4px; /* Pushes the thumb up 4px to center on the 8px track */
}

/* Adjusting the thumb for Firefox */
input[type="range"]::-moz-range-thumb {
    height: 16px;
    width: 16px;
    border-radius: 50%;
    background: #111827; /* Dark knob color */
    cursor: pointer;
    border: none; /* Ensure no border */
}
</style>

<div class="mb-8">
    <a href="/" class="mono text-sm hover:underline">← back to generate</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-1">
        <div class="border border-black p-6 sticky top-4">
            <h2 class="text-2xl font-semibold mb-6 mono">adjust_parameters()</h2>

            <div class="space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium mono">slope (m)</label>
                        <span id="mValue" class="mono text-sm bg-white px-2 py-1 border border-black">3.0</span>
                    </div>
                    <input type="range" id="mSlider" min="-10" max="10" step="0.1" value="3" class="w-full">
                    <div class="flex justify-between text-xs mono text-gray-700 mt-1">
                        <span>-10</span>
                        <span>10</span>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium mono">intercept (c)</label>
                        <span id="cValue" class="mono text-sm bg-white px-2 py-1 border border-black">0.0</span>
                    </div>
                    <input type="range" id="cSlider" min="-50" max="50" step="0.5" value="0" class="w-full">
                    <div class="flex justify-between text-xs mono text-gray-700 mt-1">
                        <span>-50</span>
                        <span>50</span>
                    </div>
                </div>

                <div id="polyOrderControl" style="display: none;">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium mono">order</label>
                        <span id="orderValue" class="mono text-sm bg-white px-2 py-1 border border-black">3</span>
                    </div>
                    <input type="range" id="orderSlider" min="1" max="9" step="1" value="3" class="w-full">
                    <div class="flex justify-between text-xs mono text-gray-700 mt-1">
                        <span>1</span>
                        <span>9</span>
                    </div>
                </div>

                <div id="learningRateControl" style="display: none;">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium mono">learning_rate</label>
                        <span id="lrValue" class="mono text-sm bg-white px-2 py-1 border border-black">1.0e-3</span>
                    </div>
                    <input type="range" id="lrSlider" min="0" max="10" step="1" value="3" class="w-full">
                    <div class="flex justify-between text-xs mono text-gray-700 mt-1">
                        <span>1.0e+0</span>
                        <span>1.0e-10</span>
                    </div>
                </div>

                <div id="roundsControl" style="display: none;">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium mono">training_rounds</label>
                        <span id="roundsValue" class="mono text-sm bg-white px-2 py-1 border border-black">1000</span>
                    </div>
                    <input type="range" id="roundsSlider" min="1000" max="10000" step="1000" value="1000" class="w-full">
                    <div class="flex justify-between text-xs mono text-gray-700 mt-1">
                        <span>1000</span>
                        <span>10000</span>
                    </div>
                </div>

                <div class="pt-4 border-t border-black">
                    <p class="text-sm mono text-gray-700 mb-2">current equation:</p>
                    <p id="equation" class="text-lg font-semibold mono">y = 3.0x + 0.0</p>
                </div>

                <div class="p-4 bg-white border border-black">
                    <p class="text-xs mono text-gray-700 mb-1">L1 penalty:</p>
                    <p id="penalty" class="text-3xl font-bold mono">--</p>
                    <p class="text-xs mono text-gray-700 mt-2">
                        Σ|y - (mx + c)|
                    </p>
                </div>

                <div class="text-xs mono text-gray-700 space-y-1">
                    <p>→ lower penalty = better fit</p>
                    <p>→ dotted lines show errors</p>
                    <p>→ adjust to minimize penalty</p>
                </div>

                <button id="resetBtn" class="btn-outline w-full mono text-sm">
                    reset to default
                </button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="border border-black p-6">
            <h2 class="text-xl font-semibold mb-4 mono">visualization</h2>

            <div id="loading" class="text-center py-16 mono text-sm animate-pulse">
                loading plot...
            </div>

            <div id="plotContainer" class="hidden">
                <img id="plotImage" src="" alt="Regression Plot" class="w-full border border-black">
            </div>

            <div class="mt-4 p-4 bg-white border border-black">
                <h3 class="font-semibold mono text-sm mb-2">legend:</h3>
                <div class="space-y-1 text-xs mono text-gray-800">
                    <p>● <span class="text-gray-700">black dots:</span> actual data points</p>
                    <p>● <span class="text-gray-700">gray dots:</span> predicted points on line</p>
                    <p>⋮ <span class="text-gray-700">dotted lines:</span> prediction errors</p>
                    <p>━ <span class="text-gray-700">solid line:</span> your regression line</p>
                </div>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-white border border-black">
            <h3 id="regressionHeader" class="font-semibold mono text-sm mb-2">understanding L1 regression:</h3>
            <p id="regressionDescription" class="text-xs mono text-gray-800">
                L1 regression (Least Absolute Deviations) minimizes the sum of absolute
                differences between actual and predicted values. Unlike L2 (squared errors),
                L1 is more robust to outliers. Try adjusting m and c to find the line
                that minimizes the total penalty!
            </p>
        </div>

    
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const mSlider = document.getElementById('mSlider');
    const cSlider = document.getElementById('cSlider');
    const orderSlider = document.getElementById('orderSlider');
    const lrSlider = document.getElementById('lrSlider');
    const roundsSlider = document.getElementById('roundsSlider');

    const mValue = document.getElementById('mValue');
    const cValue = document.getElementById('cValue');
    const orderValue = document.getElementById('orderValue');
    const lrValue = document.getElementById('lrValue');
    const roundsValue = document.getElementById('roundsValue');

    const equation = document.getElementById('equation');
    const penalty = document.getElementById('penalty');
    const plotImage = document.getElementById('plotImage');
    const plotContainer = document.getElementById('plotContainer');
    const loading = document.getElementById('loading');
    const resetBtn = document.getElementById('resetBtn');

    // Control visibility elements
    const polyOrderControl = document.getElementById('polyOrderControl');
    const learningRateControl = document.getElementById('learningRateControl');
    const roundsControl = document.getElementById('roundsControl');

    // NEW ELEMENTS FOR DYNAMIC L1/L2 INFO
    const regressionHeader = document.getElementById('regressionHeader');
    const regressionDescription = document.getElementById('regressionDescription');
    // *****************************************

    let updateTimeout;
    let regressionType = 'linear'; // Will be set from server

    // Fetch regression type on load
    fetch('/get_regression_type')
        .then(r => r.json())
        .then(data => {
            regressionType = data.regression_type;
            updateControlsVisibility();
            updatePlot(); 
        });

    function updateRegressionInfoDisplay(type) {
        if (type === 'linear') {
            regressionHeader.textContent = 'understanding L1 regression:';
            regressionDescription.innerHTML = `
                L1 regression (Least Absolute Deviations) minimizes the sum of absolute
                differences between actual and predicted values. Unlike L2 (squared errors),
                L1 is more robust to **outliers**. Try adjusting m and c to find the line
                that minimizes the total penalty!
            `;
        } else if (type === 'polynomial' || type === 'sine') {
            regressionHeader.textContent = 'understanding L2 regression (for learning):';
            regressionDescription.innerHTML = `
                L2 regression (Least Squares) minimizes the sum of **squared differences**. 
                This is the standard **cost function** used by the Gradient Descent algorithm 
                to learn the optimal polynomial weights. It is highly effective but can be 
                sensitive to extreme outliers.
            `;
        }
    }

    function updateControlsVisibility() {
        const isLinear = regressionType === 'linear';
        const isPolynomial = regressionType === 'polynomial';
        const isSine = regressionType === 'sine';

        // Show/hide controls based on regression type
        document.getElementById('mSlider').parentElement.style.display = isLinear ? 'block' : 'none';
        document.getElementById('cSlider').parentElement.style.display = isLinear ? 'block' : 'none';

        // Order control for polynomial and sine
        polyOrderControl.style.display = (isPolynomial || isSine) ? 'block' : 'none'; 
        learningRateControl.style.display = (isPolynomial || isSine) ? 'block' : 'none';
        roundsControl.style.display = (isPolynomial || isSine) ? 'block' : 'none';

        // Update the penalty display formula based on type
        if (isLinear) {
            penalty.nextElementSibling.textContent = 'Σ|y - (mx + c)|';
        } else if (isPolynomial) {
            penalty.nextElementSibling.textContent = 'L2 Error (Gradient Descent)';
        } else if (isSine) {
            penalty.nextElementSibling.textContent = 'L2 Error (Polynomial Fit to Sine)';
        }
        
        // DYNAMICALLY UPDATE THE EXPLANATION TEXT
        updateRegressionInfoDisplay(regressionType);
    }

    function updatePlot() {
        const params = {
            regression_type: regressionType
        };

        if (regressionType === 'linear') {
            const m = parseFloat(mSlider.value);
            const c = parseFloat(cSlider.value);

            mValue.textContent = m.toFixed(1);
            cValue.textContent = c.toFixed(1);

            const sign = c >= 0 ? '+' : '';
            equation.textContent = `y = ${m.toFixed(1)}x ${sign} ${c.toFixed(1)}`;

            params.m = m;
            params.c = c;
            
            // Re-apply L1 formula display for linear type
            penalty.nextElementSibling.textContent = 'Σ|y - (mx + c)|'; 

        } else {
            const order = parseInt(orderSlider.value);
            // Calculate learning rate as 10 to the power of negative slider value
            const lrExponent = parseInt(lrSlider.value); 
            const lr = Math.pow(10, -lrExponent); 
            const rounds = parseInt(roundsSlider.value);

            orderValue.textContent = order;
            // Display learning rate in scientific notation (e.g., 1.0e-3)
            lrValue.textContent = lr.toExponential(1); 
            roundsValue.textContent = rounds;

            if (regressionType === 'polynomial') {
                equation.textContent = `polynomial (order=${order})`;
                penalty.nextElementSibling.textContent = 'L2 Error (Gradient Descent)';
            } else {
                equation.textContent = `Fit sin(2πx) with order ${order}`;
                penalty.nextElementSibling.textContent = 'L2 Error (Polynomial Fit to Sine)';
            }

            params.order = order;
            params.learning_rate = lr;
            params.rounds = rounds;
        }

        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(async () => {
            try {
                const response = await fetch('/update_plot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();

                if (data.image) {
                    plotImage.src = 'data:image/png;base64,' + data.image;
                    // Penalty is L1 for linear, L2 for others in this implementation
                    penalty.textContent = data.penalty.toFixed(2); 

                    loading.classList.add('hidden');
                    plotContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error updating plot:', error);
                // Hide plot and show loading on error
                plotContainer.classList.add('hidden');
                loading.classList.remove('hidden');
                penalty.textContent = '--';
            }
        }, 300);
    }

    // Event listeners
    mSlider?.addEventListener('input', updatePlot);
    cSlider?.addEventListener('input', updatePlot);
    orderSlider?.addEventListener('input', updatePlot);
    lrSlider?.addEventListener('input', updatePlot);
    roundsSlider?.addEventListener('input', updatePlot);

    resetBtn.addEventListener('click', () => {
        if (regressionType === 'linear') {
            mSlider.value = 3;
            cSlider.value = 0;
            // Reset L1 display for linear
            penalty.nextElementSibling.textContent = 'Σ|y - (mx + c)|'; 
        } else {
            orderSlider.value = 3;
            lrSlider.value = 3; 
            roundsSlider.value = 1000;
            // Reset L2 display for non-linear
            updateControlsVisibility();
        }
        updatePlot();
    });

    // Initial plot is now called after fetching regressionType
    // updatePlot(); 
</script>
{% endblock %}